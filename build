#!/usr/bin/env sh
set -e			# Stop on first error

CC="cc"
CFLAGS="-std=c99"

CFLAGS="$CFLAGS -Wall -Wextra -Wshadow -pedantic"
CFLAGS="$CFLAGS -Wmissing-declarations -Wswitch-enum"

# Disable selected warnings
CFLAGS="$CFLAGS -Wno-missing-braces"
CFLAGS="$CFLAGS -Wno-deprecated-declarations"
CFLAGS="$CFLAGS -Wno-format-truncation"

CFLAGS="$CFLAGS -D_XOPEN_SOURCE=500"		# for strdup()
CFLAGS="$CFLAGS -D_POSIX_C_SOURCE=200112L"	# for setenv()

cd embed
$CC $CFLAGS -o embed main.c

echo "" > ../embed.c
./embed embed_binds            < binds            >> ../embed.c
./embed embed_help_binds_gmi   < help/binds.gmi   >> ../embed.c
./embed embed_help_cache_gmi   < help/cache.gmi   >> ../embed.c
./embed embed_help_envs_gmi    < help/envs.gmi    >> ../embed.c
./embed embed_help_history_gmi < help/history.gmi >> ../embed.c
./embed embed_help_index_gmi   < help/index.gmi   >> ../embed.c
./embed embed_help_links_gmi   < help/links.gmi   >> ../embed.c
./embed embed_help_session_gmi < help/session.gmi >> ../embed.c
./embed embed_help_shell_gmi   < help/shell.gmi   >> ../embed.c
./embed embed_help_support_gmi < help/support.gmi >> ../embed.c

cd ..

$CC $CFLAGS -c util.c  &
$CC $CFLAGS -c uri.c   &
$CC $CFLAGS -c fetch.c &
$CC $CFLAGS -c link.c  &
$CC $CFLAGS -c undo.c  &
$CC $CFLAGS -c bind.c  &
$CC $CFLAGS -c cache.c &
$CC $CFLAGS -c gmi.c   &
$CC $CFLAGS -c gph.c   &
$CC $CFLAGS -c mime.c  &
$CC $CFLAGS -c main.c  &
wait

$CC $CFLAGS -o yupa *.o -lssl -lcrypto

rm *.o embed/embed embed.c
